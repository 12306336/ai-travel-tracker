<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Flight Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <style>
        #flightMap { height: 400px; }
        .aircraft-marker {
            transform: rotate(45deg);
            text-align: center;
            line-height: 24px;
            color: #3b82f6;
            font-size: 18px;
            text-shadow: 0 0 2px white;
        }
        .json-response {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .awesomplete {
            width: 100%;
            display: block;
        }
        .awesomplete > ul {
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .awesomplete > ul > li {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .awesomplete > ul > li[aria-selected="true"] {
            background: #3b82f6;
            color: white;
        }
        .awesomplete mark {
            background: rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans" style="background-image: url(./img2.jpg);">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white text-shadow mb-2 ">AI Flight Tracker</h1>
            <p class="text-white text-2xl font-sans">Track flights with AI-powered insights</p>
        </header>

        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <h2 class="text-xl font-semibold mb-4">Flight Search</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search Type</label>
                            <div class="flex space-x-2">
                                <button id="btnFlightNumber" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md">By Flight </button>
                                <button id="btnRoute" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md">By Route</button>
                            </div>
                        </div>

                        <div id="flightNumberSearch">
                            <div class="mb-4">
                                <label for="flightNumber" class="block text-sm font-medium text-gray-700 mb-1">Flight Number</label>
                                <input type="text" id="flightNumber" placeholder="AI101 (DEL-BOM)" class="w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div class="mb-4">
                                <label for="flightDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="flightDate" class="w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>

                        <div id="routeSearch" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="departureAirport" class="block text-sm font-medium text-gray-700 mb-1">From</label>
                                    <input type="text" id="departureAirport" placeholder="Delhi or DEL" class="w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                                <div>
                                    <label for="arrivalAirport" class="block text-sm font-medium text-gray-700 mb-1">To</label>
                                    <input type="text" id="arrivalAirport" placeholder="Mumbai or BOM" class="w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="routeDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="routeDate" class="w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                        </div>

                        <button id="searchFlights" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                            <span id="searchText">Search Flights</span>
                            <span id="searchSpinner" class="ml-2 hidden loading-spinner">↻</span>
                        </button>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <div id="flightMap" class="rounded-lg overflow-hidden"></div>
                </div>
            </div>
        </div>

        <div id="flightDetails" class="bg-white rounded-xl shadow-md p-6 mb-8 hidden">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-800" id="flightNumberHeader">Flight AI101</h2>
                    <p class="text-gray-600" id="flightRoute">DEL → BOM</p>
                </div>
                <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium" id="flightStatus">On Time</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Departure</p>
                    <p class="font-semibold" id="departureTime">10:00 AM</p>
                    <p class="text-sm" id="departureAirportInfo">Indira Gandhi Intl (DEL)</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Arrival</p>
                    <p class="font-semibold" id="arrivalTime">12:30 PM</p>
                    <p class="text-sm" id="arrivalAirportInfo">Chhatrapati Shivaji Intl (BOM)</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Duration</p>
                    <p class="font-semibold" id="flightDuration">2h 30m</p>
                    <p class="text-sm" id="flightDistance">1,139 miles</p>
                </div>
            </div>

            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    AI Insights
                </h3>
                <div id="aiInsights">
                    <div class="flex items-center text-gray-600">
                        <span class="loading-spinner mr-2">↻</span>
                        <span>Analyzing flight data...</span>
                    </div>
                </div>
            </div>

<!-- raw response -->
        <div id="errorContainer" class="bg-red-50 border-l-4 border-red-500 p-4 mb-8 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="errorMessage"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <script>
        // Configuration
        const config = {
            geminiApiKey: 'AIzaSyBhjBIghyjRD6Z1DJP2noOOXNLCJaO3Hpg' // Replace with your actual API key
        };

        // Enhanced Indian airport data with city names and common aliases
        const indianAirports = [
            { code: 'DEL', name: 'Indira Gandhi International Airport', city: 'Delhi', aliases: ['New Delhi', 'NCR', 'Dilli'], latitude: 28.5562, longitude: 77.1000 },
            { code: 'BOM', name: 'Chhatrapati Shivaji Maharaj International Airport', city: 'Mumbai', aliases: ['Bombay'], latitude: 19.0896, longitude: 72.8656 },
            { code: 'BLR', name: 'Kempegowda International Airport', city: 'Bangalore', aliases: ['Bengaluru'], latitude: 13.1986, longitude: 77.7066 },
            { code: 'HYD', name: 'Rajiv Gandhi International Airport', city: 'Hyderabad', aliases: ['Secunderabad'], latitude: 17.2403, longitude: 78.4294 },
            { code: 'MAA', name: 'Chennai International Airport', city: 'Chennai', aliases: ['Madras'], latitude: 12.9822, longitude: 80.1636 },
            { code: 'CCU', name: 'Netaji Subhas Chandra Bose International Airport', city: 'Kolkata', aliases: ['Calcutta'], latitude: 22.6543, longitude: 88.4467 },
            { code: 'AMD', name: 'Sardar Vallabhbhai Patel International Airport', city: 'Ahmedabad', latitude: 23.0772, longitude: 72.6347 },
            { code: 'PNQ', name: 'Pune Airport', city: 'Pune', latitude: 18.5822, longitude: 73.9197 },
            { code: 'GOI', name: 'Goa International Airport', city: 'Goa', aliases: ['Dabolim'], latitude: 15.3808, longitude: 73.8314 },
            { code: 'JAI', name: 'Jaipur International Airport', city: 'Jaipur', latitude: 26.8242, longitude: 75.8122 },
            { code: 'LKO', name: 'Chaudhary Charan Singh Airport', city: 'Lucknow', latitude: 26.7606, longitude: 80.8893 },
            { code: 'GAU', name: 'Lokpriya Gopinath Bordoloi International Airport', city: 'Guwahati', latitude: 26.1061, longitude: 91.5859 },
            { code: 'PAT', name: 'Jay Prakash Narayan Airport', city: 'Patna', latitude: 25.5913, longitude: 85.0880 },
            { code: 'IXC', name: 'Chandigarh Airport', city: 'Chandigarh', latitude: 30.6735, longitude: 76.7885 },
            { code: 'COK', name: 'Cochin International Airport', city: 'Kochi', aliases: ['Cochin'], latitude: 10.1520, longitude: 76.4019 },
            { code: 'TRV', name: 'Trivandrum International Airport', city: 'Thiruvananthapuram', aliases: ['Trivandrum'], latitude: 8.4821, longitude: 76.9204 },
            { code: 'AYJ', name: 'Maharishi Valmiki International Airport', city: 'Ayodhya', latitude: 26.7606, longitude: 82.1547 },
            { code: 'VNS', name: 'Lal Bahadur Shastri Airport', city: 'Varanasi', latitude: 25.4524, longitude: 82.8593 },
            { code: 'IDR', name: 'Devi Ahilya Bai Holkar Airport', city: 'Indore', latitude: 22.7218, longitude: 75.8011 },
            { code: 'NAG', name: 'Dr. Babasaheb Ambedkar International Airport', city: 'Nagpur', latitude: 21.0922, longitude: 79.0472 }
        ];

        // Create searchable list for autocomplete
        const airportSearchList = indianAirports.map(airport => {
            const aliases = airport.aliases ? airport.aliases.join(', ') : '';
            return `${airport.city} (${airport.code}) - ${airport.name} | ${aliases}`;
        });

        // Predefined flight routes with realistic paths
        const flightRoutes = {
            'DEL-BOM': {
                path: [
                    { latitude: 28.5562, longitude: 77.1000 }, // DEL
                    { latitude: 26.4499, longitude: 77.3536 }, // Jaipur
                    { latitude: 23.2547, longitude: 77.4029 }, // Bhopal
                    { latitude: 21.1146, longitude: 76.1191 }, // Akola
                    { latitude: 19.0896, longitude: 72.8656 }  // BOM
                ],
                duration: 150,
                distance: 1139
            },
            'DEL-HYD': {
                path: [
                    { latitude: 28.5562, longitude: 77.1000 }, // DEL
                    { latitude: 26.8467, longitude: 80.9462 }, // Lucknow
                    { latitude: 23.3441, longitude: 85.3096 }, // Ranchi
                    { latitude: 20.5515, longitude: 83.1045 }, // Raipur
                    { latitude: 17.2403, longitude: 78.4294 }  // HYD
                ],
                duration: 135,
                distance: 1050
            },
            'BLR-BOM': {
                path: [
                    { latitude: 13.1986, longitude: 77.7066 }, // BLR
                    { latitude: 15.3173, longitude: 75.7139 }, // Hubli
                    { latitude: 17.6868, longitude: 75.3303 }, // Solapur
                    { latitude: 18.5204, longitude: 73.8567 }, // Pune
                    { latitude: 19.0896, longitude: 72.8656 }  // BOM
                ],
                duration: 120,
                distance: 560
            },
            'DEL-BLR': {
                path: [
                    { latitude: 28.5562, longitude: 77.1000 }, // DEL
                    { latitude: 25.5941, longitude: 85.1376 }, // Patna
                    { latitude: 21.1458, longitude: 79.0882 }, // Nagpur
                    { latitude: 17.2403, longitude: 78.4294 }, // HYD
                    { latitude: 13.1986, longitude: 77.7066 }  // BLR
                ],
                duration: 180,
                distance: 1350
            }
        };

        $(document).ready(function() {
            // Initialize autocomplete for airport inputs
            new Awesomplete(document.getElementById('departureAirport'), {
                list: airportSearchList,
                minChars: 1,
                maxItems: 10,
                autoFirst: true,
                filter: function(text, input) {
                    return Awesomplete.FILTER_CONTAINS(text, input.match(/[^,]*$/)[0]);
                },
                item: function(text, input) {
                    return Awesomplete.ITEM(text, input.match(/[^,]*$/)[0]);
                },
                replace: function(text) {
                    const before = this.input.value.match(/^.+,\s*|/)[0];
                    const selectedText = text.split('|')[0].trim();
                    const airportCode = selectedText.match(/\(([A-Z]{3})\)/)[1];
                    this.input.value = airportCode;
                }
            });

            new Awesomplete(document.getElementById('arrivalAirport'), {
                list: airportSearchList,
                minChars: 1,
                maxItems: 10,
                autoFirst: true,
                filter: function(text, input) {
                    return Awesomplete.FILTER_CONTAINS(text, input.match(/[^,]*$/)[0]);
                },
                item: function(text, input) {
                    return Awesomplete.ITEM(text, input.match(/[^,]*$/)[0]);
                },
                replace: function(text) {
                    const before = this.input.value.match(/^.+,\s*|/)[0];
                    const selectedText = text.split('|')[0].trim();
                    const airportCode = selectedText.match(/\(([A-Z]{3})\)/)[1];
                    this.input.value = airportCode;
                }
            });

            // Initialize map centered on India
            const map = L.map('flightMap', {
                center: [20.5937, 78.9629], // Center of India
                zoom: 5,
                minZoom: 4,
                maxBounds: [
                    [5.0, 65.0],  // SW bounds
                    [35.0, 95.0]   // NE bounds
                ]
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);

            let flightPath = null;

            // Toggle search type
            $('#btnFlightNumber').click(function() {
                $(this).removeClass('bg-gray-200 text-gray-800').addClass('bg-blue-600 text-white');
                $('#btnRoute').removeClass('bg-blue-600 text-white').addClass('bg-gray-200 text-gray-800');
                $('#flightNumberSearch').removeClass('hidden');
                $('#routeSearch').addClass('hidden');
            });

            $('#btnRoute').click(function() {
                $(this).removeClass('bg-gray-200 text-gray-800').addClass('bg-blue-600 text-white');
                $('#btnFlightNumber').removeClass('bg-blue-600 text-white').addClass('bg-gray-200 text-gray-800');
                $('#routeSearch').removeClass('hidden');
                $('#flightNumberSearch').addClass('hidden');
            });

            // Search flights
            $('#searchFlights').click(async function() {
                try {
                    $('#searchText').hide();
                    $('#searchSpinner').removeClass('hidden');
                    $('#errorContainer').addClass('hidden');

                    const isFlightNumberSearch = !$('#flightNumberSearch').hasClass('hidden');
                    
                    if (isFlightNumberSearch) {
                        const flightNumber = $('#flightNumber').val().trim().toUpperCase();
                        const date = $('#flightDate').val();
                        
                        if (!flightNumber) {
                            throw new Error('Please enter a flight number');
                        }
                        
                        const flight = await mockGetFlightByNumber(flightNumber, date);
                        displayFlightDetails(flight);
                        await generateAIInsights(flight);
                    } else {
                        const departure = $('#departureAirport').val().trim();
                        const arrival = $('#arrivalAirport').val().trim();
                        const date = $('#routeDate').val();
                        
                        if (!departure || !arrival) {
                            throw new Error('Please enter both departure and arrival locations');
                        }
                        
                        const flights = await mockGetFlightsByRoute(departure, arrival, date);
                        if (flights.length > 0) {
                            displayFlightDetails(flights[0]);
                            await generateAIInsights(flights[0]);
                        } else {
                            throw new Error('No flights found for this route. Try using airport codes (DEL, BOM) or major city names.');
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError(error.message);
                } finally {
                    $('#searchText').show();
                    $('#searchSpinner').addClass('hidden');
                }
            });

            // Mock flight data functions
            async function mockGetFlightByNumber(flightNumber, date) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        // Default to DEL-BOM if no specific route found
                        const routeKey = flightNumber.substring(0, 2) === 'AI' ? 'DEL-BOM' : 
                                        flightNumber.substring(0, 2) === '6E' ? 'DEL-HYD' :
                                        flightNumber.substring(0, 2) === 'UK' ? 'BLR-BOM' : 'DEL-BLR';
                        
                        const route = flightRoutes[routeKey] || flightRoutes['DEL-BOM'];
                        const departureCode = routeKey.split('-')[0];
                        const arrivalCode = routeKey.split('-')[1];
                        const departureAirport = indianAirports.find(a => a.code === departureCode);
                        const arrivalAirport = indianAirports.find(a => a.code === arrivalCode);
                        
                        resolve({
                            airline: flightNumber.substring(0, 2),
                            number: flightNumber.substring(2),
                            departure: {
                                airport: departureCode,
                                airportName: departureAirport.name,
                                city: departureAirport.city,
                                scheduled: date ? `${date}T10:00:00` : new Date().toISOString().split('T')[0] + 'T10:00:00',
                                latitude: departureAirport.latitude,
                                longitude: departureAirport.longitude
                            },
                            arrival: {
                                airport: arrivalCode,
                                airportName: arrivalAirport.name,
                                city: arrivalAirport.city,
                                scheduled: date ? `${date}T${10 + Math.floor(route.duration/60)}:${route.duration%60}:00` : 
                                                new Date().toISOString().split('T')[0] + `T${10 + Math.floor(route.duration/60)}:${route.duration%60}:00`,
                                latitude: arrivalAirport.latitude,
                                longitude: arrivalAirport.longitude
                            },
                            duration: route.duration,
                            distance: route.distance,
                            aircraft: route.distance > 1000 ? 'Boeing 787' : 'Airbus A320',
                            status: 'On Time',
                            progress: 0,
                            path: route.path
                        });
                    }, 500);
                });
            }

            async function mockGetFlightsByRoute(departureInput, arrivalInput, date) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        // Find airports by code, city name, or alias
                        const findAirport = (input) => {
                            const normalizedInput = input.trim().toUpperCase();
                            
                            // First try exact code match
                            const byCode = indianAirports.find(a => a.code === normalizedInput);
                            if (byCode) return byCode;
                            
                            // Then try city name match
                            const byCity = indianAirports.find(a => 
                                a.city.toLowerCase() === input.trim().toLowerCase() || 
                                (a.aliases && a.aliases.some(alias => 
                                    alias.toLowerCase() === input.trim().toLowerCase()))
                            );
                            if (byCity) return byCity;
                            
                            // Then try partial matches in city name or airport name
                            const byPartial = indianAirports.find(a => 
                                a.city.toLowerCase().includes(input.trim().toLowerCase()) || 
                                a.name.toLowerCase().includes(input.trim().toLowerCase())
                            );
                            return byPartial || null;
                        };
                        
                        const departureAirport = findAirport(departureInput);
                        const arrivalAirport = findAirport(arrivalInput);
                        
                        if (!departureAirport || !arrivalAirport) {
                            resolve([]);
                            return;
                        }
                        
                        const routeKey = `${departureAirport.code}-${arrivalAirport.code}`;
                        const route = flightRoutes[routeKey] || {
                            path: [
                                { latitude: departureAirport.latitude, longitude: departureAirport.longitude },
                                { latitude: (departureAirport.latitude + arrivalAirport.latitude)/2, 
                                  longitude: (departureAirport.longitude + arrivalAirport.longitude)/2 },
                                { latitude: arrivalAirport.latitude, longitude: arrivalAirport.longitude }
                            ],
                            duration: 120,
                            distance: 800
                        };
                        
                        resolve([{
                            airline: 'AI',
                            number: '101',
                            departure: {
                                airport: departureAirport.code,
                                airportName: departureAirport.name,
                                city: departureAirport.city,
                                scheduled: date ? `${date}T08:00:00` : new Date().toISOString().split('T')[0] + 'T08:00:00',
                                latitude: departureAirport.latitude,
                                longitude: departureAirport.longitude
                            },
                            arrival: {
                                airport: arrivalAirport.code,
                                airportName: arrivalAirport.name,
                                city: arrivalAirport.city,
                                scheduled: date ? `${date}T${8 + Math.floor(route.duration/60)}:${route.duration%60}:00` : 
                                                new Date().toISOString().split('T')[0] + `T${8 + Math.floor(route.duration/60)}:${route.duration%60}:00`,
                                latitude: arrivalAirport.latitude,
                                longitude: arrivalAirport.longitude
                            },
                            duration: route.duration,
                            distance: route.distance,
                            aircraft: route.distance > 1000 ? 'Boeing 787' : 'Airbus A320',
                            status: 'On Time',
                            progress: 0,
                            path: route.path
                        }]);
                    }, 500);
                });
            }

            // Display flight details
            function displayFlightDetails(flight) {
                // Update basic flight info
                $('#flightNumberHeader').text(`${flight.airline} ${flight.number}`);
                $('#flightRoute').text(`${flight.departure.airport} → ${flight.arrival.airport}`);
                $('#flightStatus').text(flight.status);
                $('#flightStatus').removeClass('bg-green-100 text-green-800 bg-yellow-100 text-yellow-800 bg-red-100 text-red-800')
                                  .addClass(
                                      flight.status === 'On Time' ? 'bg-green-100 text-green-800' : 
                                      flight.status === 'Delayed' ? 'bg-yellow-100 text-yellow-800' : 
                                      'bg-red-100 text-red-800'
                                  );
                
                // Update times
                $('#departureTime').text(formatTime(flight.departure.scheduled));
                $('#departureAirportInfo').text(`${flight.departure.airportName} (${flight.departure.airport})`);
                $('#arrivalTime').text(formatTime(flight.arrival.scheduled));
                $('#arrivalAirportInfo').text(`${flight.arrival.airportName} (${flight.arrival.airport})`);
                
                // Update duration and distance
                $('#flightDuration').text(formatDuration(flight.duration));
                $('#flightDistance').text(`${flight.distance.toLocaleString()} miles`);
                
                // Update flight path on map
                updateFlightMap(flight);
                
                // Show flight details
                $('#flightDetails').removeClass('hidden');
            }

            // Update flight map with proper routing
            function updateFlightMap(flight) {
                // Clear previous flight path
                if (flightPath) {
                    map.removeLayer(flightPath);
                }
                
                // Add markers for airports
                const departureMarker = L.marker([flight.departure.latitude, flight.departure.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${flight.departure.airport}</b><br>${flight.departure.airportName}`);
                
                const arrivalMarker = L.marker([flight.arrival.latitude, flight.arrival.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${flight.arrival.airport}</b><br>${flight.arrival.airportName}`);
                
                // Add flight path if available
                if (flight.path && flight.path.length > 0) {
                    flightPath = L.polyline(flight.path.map(p => [p.latitude, p.longitude]), {
                        color: '#3b82f6',
                        weight: 3,
                        dashArray: '5, 5'
                    }).addTo(map);
                    
                    // Create bounds that include all points with padding
                    const bounds = L.latLngBounds([
                        [flight.departure.latitude, flight.departure.longitude],
                        [flight.arrival.latitude, flight.arrival.longitude]
                    ]);
                    
                    // Include all path points in bounds
                    flight.path.forEach(point => {
                        bounds.extend([point.latitude, point.longitude]);
                    });
                    
                    // Fit map to bounds with padding
                    map.fitBounds(bounds, { 
                        padding: [50, 50],
                        maxZoom: 7  // Prevent zooming in too close
                    });
                } else {
                    // Fallback to just showing both airports
                    const bounds = L.latLngBounds([
                        [flight.departure.latitude, flight.departure.longitude],
                        [flight.arrival.latitude, flight.arrival.longitude]
                    ]);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }

            // Generate AI insights using Gemini API
            async function generateAIInsights(flight) {
                $('#aiInsights').html(`
                    <div class="flex items-center text-gray-600">
                        <span class="loading-spinner mr-2">↻</span>
                        <span>Analyzing flight data...</span>
                    </div>
                `);
                $('#jsonResponse').text('Fetching response...');
                
                try {
                    // Strict prompt to ensure flight-related JSON response
                    const prompt = `As an expert flight analyst, provide detailed analysis of:
Flight: ${flight.airline} ${flight.number}
Route: ${flight.departure.airport} (${flight.departure.city}) to ${flight.arrival.airport} (${flight.arrival.city})
Departure: ${new Date(flight.departure.scheduled).toLocaleString()}
Aircraft: ${flight.aircraft}
Distance: ${flight.distance} miles

Respond with ONLY valid JSON containing these exact fields:
{
  "flightAnalysis": {
    "delayProbability": "number (0-100)",
    "delayReasons": ["array", "of", "strings"],
    "routeEfficiency": "string",
    "weatherImpact": "string",
    "aircraftAnalysis": "string"
  },
  "passengerTips": {
    "boarding": "string",
    "inFlight": "string",
    "connections": "string"
  },
  "interestingFacts": ["array", "of", "strings"]
}

IMPORTANT:
- Focus specifically on Indian aviation context
- Include relevant Indian weather patterns and air traffic conditions
- Provide tips specific to Indian airports
- Respond ONLY with valid JSON
- Do not include any additional text
- Maintain the exact field names specified`;

                    const response = await callGeminiAPI(prompt);
                    
                    // Clean the response by removing any non-JSON text before or after the braces
                    const jsonStart = response.indexOf('{');
                    const jsonEnd = response.lastIndexOf('}') + 1;
                    const cleanResponse = response.substring(jsonStart, jsonEnd);
                    
                    $('#jsonResponse').text(cleanResponse);
                    
                    try {
                        const jsonData = JSON.parse(cleanResponse);
                        displayFormattedInsights(jsonData);
                    } catch (e) {
                        console.error('JSON parsing error:', e);
                        $('#aiInsights').html(`
                            <div class="text-red-600">
                                <p>Error parsing JSON response. Showing raw response:</p>
                                <div class="json-response mt-2">${cleanResponse}</div>
                            </div>
                        `);
                    }
                } catch (error) {
                    console.error('AI analysis failed:', error);
                    $('#aiInsights').html(`
                        <div class="text-red-600">
                            <p>Error: ${error.message}</p>
                        </div>
                    `);
                }
            }

            // Call Gemini API
            async function callGeminiAPI(prompt) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${config.geminiApiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            safetySettings: [
                                {
                                    category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                    threshold: "BLOCK_MEDIUM_AND_ABOVE"
                                }
                            ],
                            generationConfig: {
                                temperature: 0.3,
                                maxOutputTokens: 1000
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'API request failed');
                    }
                    
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    throw error;
                }
            }

            // Display formatted insights
            function displayFormattedInsights(data) {
                // Check if data exists and has the expected structure
                if (!data || typeof data !== 'object') {
                    $('#aiInsights').html(`
                        <div class="text-red-600">
                            <p>Invalid data format received from API</p>
                        </div>
                    `);
                    return;
                }

                let html = '<div class="space-y-4">';
                
                // Flight Analysis Section
                if (data.flightAnalysis) {
                    html += `
                        <div class="border-b pb-4">
                            <h4 class="font-semibold text-lg mb-3 text-blue-800">Flight Analysis</h4>
                            <div class="space-y-3">
                                ${data.flightAnalysis.delayProbability !== undefined ? `
                                <div class="flex items-center">
                                    <span class="font-medium w-40">Delay Probability:</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                        data.flightAnalysis.delayProbability < 20 ? 'bg-green-100 text-green-800' :
                                        data.flightAnalysis.delayProbability < 50 ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">
                                        ${data.flightAnalysis.delayProbability}%
                                    </span>
                                </div>
                                ` : ''}
                                
                                ${data.flightAnalysis.delayReasons ? `
                                <div>
                                    <p class="font-medium mb-1">Delay Reasons:</p>
                                    <ul class="list-disc list-inside pl-4 text-sm">
                                        ${data.flightAnalysis.delayReasons.map(reason => `<li>${reason}</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}
                                
                                ${data.flightAnalysis.routeEfficiency ? `
                                <p><span class="font-medium">Route Efficiency:</span> ${data.flightAnalysis.routeEfficiency}</p>
                                ` : ''}
                                
                                ${data.flightAnalysis.weatherImpact ? `
                                <p><span class="font-medium">Weather Impact:</span> ${data.flightAnalysis.weatherImpact}</p>
                                ` : ''}
                                
                                ${data.flightAnalysis.aircraftAnalysis ? `
                                <p><span class="font-medium">Aircraft Analysis:</span> ${data.flightAnalysis.aircraftAnalysis}</p>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Passenger Tips Section
                if (data.passengerTips) {
                    html += `
                        <div class="border-b pb-4">
                            <h4 class="font-semibold text-lg mb-3 text-blue-800">Passenger Tips</h4>
                            <div class="space-y-3">
                                ${data.passengerTips.boarding ? `
                                <p><span class="font-medium">Boarding:</span> ${data.passengerTips.boarding}</p>
                                ` : ''}
                                
                                ${data.passengerTips.inFlight ? `
                                <p><span class="font-medium">In-Flight:</span> ${data.passengerTips.inFlight}</p>
                                ` : ''}
                                
                                ${data.passengerTips.connections ? `
                                <p><span class="font-medium">Connections:</span> ${data.passengerTips.connections}</p>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Interesting Facts Section
                if (data.interestingFacts) {
                    html += `
                        <div>
                            <h4 class="font-semibold text-lg mb-3 text-blue-800">Interesting Facts</h4>
                            <ul class="list-disc list-inside pl-4 text-sm">
                                ${data.interestingFacts.map(fact => `<li>${fact}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += '</div>';
                $('#aiInsights').html(html);
            }

            // Helper functions
            function formatTime(isoString) {
                const date = new Date(isoString);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            function formatDuration(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}h ${mins}m`;
            }

            function showError(message) {
                $('#errorMessage').text(message);
                $('#errorContainer').removeClass('hidden');
            }
        });
    </script>
</body>
</html>